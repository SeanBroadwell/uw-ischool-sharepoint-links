<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UW iSchool Units</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>UW iSchool Units</h1>
  <button class="add-card" id="addCardBtn">+ Add Card</button>
</header>

<main class="card-grid" id="cardGrid"></main>

<script>
const cardGrid = document.getElementById("cardGrid");
const addCardBtn = document.getElementById("addCardBtn");
addCardBtn.textContent = "+ Add Unit";

// Helper to attach unit events
function attachUnitLogic(card, unitId) {
  const viewMode = card.querySelector(".view-mode");
  const editMode = card.querySelector(".edit-mode");

  const editBtn = card.querySelector(".edit-btn");
  const deleteBtn = card.querySelector(".delete-btn");
  const saveBtn = card.querySelector(".save-btn");
  const cancelBtn = card.querySelector(".cancel-btn");
  const openBtn = card.querySelector(".open-unit");

  openBtn.onclick = () => {
    window.location.href = `/unit.html?id=${unitId}`;
  };

  editBtn.onclick = () => {
    viewMode.classList.add("hidden");
    editMode.classList.remove("hidden");
  };

  cancelBtn.onclick = () => {
    editMode.classList.add("hidden");
    viewMode.classList.remove("hidden");
  };

  saveBtn.onclick = async () => {
    const updatedData = {
      name: editMode.querySelector(".edit-name").value,
      description: editMode.querySelector(".edit-description").value,
      managers: editMode.querySelector(".edit-managers").value
    };

    const res = await fetch(`/api/units/${unitId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updatedData)
    });
    const savedUnit = await res.json();

    viewMode.querySelector(".unit-name").textContent = savedUnit.name;
    viewMode.querySelector(".unit-description").textContent = savedUnit.description;
    viewMode.querySelector(".unit-managers").textContent = savedUnit.managers;

    editMode.classList.add("hidden");
    viewMode.classList.remove("hidden");
  };

  deleteBtn.onclick = async () => {
    await fetch(`/api/units/${unitId}`, { method: "DELETE" });
    card.remove();
  };
}

// Create unit card element
function createUnitElement(unit) {
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <div class="view-mode">
      <h2 class="unit-name">${unit.name || ''}</h2>
      <p class="unit-description">${unit.description || ''}</p>
      <p class="unit-managers"><strong>Managers:</strong> ${unit.managers || ''}</p>

      <div class="card-actions">
        <button class="open-unit">Open Unit</button>
        <div>
          <button class="edit-btn">Edit</button>
          <button class="delete-btn">Delete</button>
        </div>
      </div>
    </div>

    <div class="edit-mode hidden">
      <input class="edit-name" type="text" placeholder="Unit Name" value="${unit.name || ''}" />
      <textarea class="edit-description" placeholder="Description">${unit.description || ''}</textarea>
      <input class="edit-managers" type="text" placeholder="Managers" value="${unit.managers || ''}" />

      <div class="card-actions">
        <button class="save-btn">Save</button>
        <button class="cancel-btn">Cancel</button>
      </div>
    </div>
  `;

  attachUnitLogic(card, unit._id);
  return card;
}

// Load all units
async function loadUnits() {
  const res = await fetch("/api/units");
  const units = await res.json();
  cardGrid.innerHTML = "";
  units.forEach(u => cardGrid.appendChild(createUnitElement(u)));
}

// Add new unit
addCardBtn.onclick = async () => {
  const newUnit = { name: "", description: "", managers: "" };

  const res = await fetch("/api/units", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(newUnit)
  });
  const savedUnit = await res.json();

  const card = createUnitElement(savedUnit);
  cardGrid.appendChild(card);

  // Auto-open edit mode
  card.querySelector(".view-mode").classList.add("hidden");
  card.querySelector(".edit-mode").classList.remove("hidden");
  card.querySelector(".edit-name").focus();
};

loadUnits();
</script>


</body>
</html>
